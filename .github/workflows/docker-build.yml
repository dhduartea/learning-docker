name: ğŸ³ Docker Build & Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ğŸ” Lint Dockerfiles
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: |
          **/Dockerfile
          **/*.Dockerfile
        format: sarif
        output-file: hadolint-report.sarif
        
    - name: ğŸ§ª Build Docker images
      run: |
        echo "ğŸ”¨ Building Docker images..."
        
        # Build 03_05 exercise
        if [ -f "03_05/Dockerfile" ]; then
          echo "Building 03_05..."
          docker build -t learning-docker:03_05 ./03_05
        fi
        
        # Build 03_06 exercise
        if [ -f "03_06/Dockerfile" ]; then
          echo "Building 03_06..."
          docker build -t learning-docker:03_06 ./03_06
        fi
        
        # Build 03_08 exercise
        if [ -f "03_08/web-server.Dockerfile" ]; then
          echo "Building 03_08..."
          docker build -f ./03_08/web-server.Dockerfile -t learning-docker:03_08 ./03_08
        fi
        
        # Build 04_03 exercise
        if [ -f "04_03_after/Dockerfile" ]; then
          echo "Building 04_03_after..."
          docker build -t learning-docker:04_03_after ./04_03_after
        fi
        
        echo "âœ… All images built successfully!"
        
    - name: ğŸ“Š Upload SARIF file
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: hadolint-report.sarif
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up Docker images..."
        docker system prune -f
        docker image prune -f
